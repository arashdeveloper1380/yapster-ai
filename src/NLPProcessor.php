<?php

namespace YapsterAi;

class NLPProcessor {

    private array $patterns = [

        'birthday' => [
            '/(?:تولد|روز تولد|زمان تولد|تاریخ تولد|سالروز) من (?:کی است|کی می‌باشد|چیست|بیشتر بگو|می‌باشد|چیست؟|کی|چه زمانی|چه روزی)/',
            '/آیا می‌توانی بگویی روز تولد من چیست؟/',
            '/تاریخ تولد من کی است؟/',
            '/تاریخ تولد من چند است؟/',
            '/چندم تولد من است؟/',
            '/می‌خواهید بگویید تولد من چه زمانی است؟/',
            '/تولد من چه روزی است؟/',
            '/چه تاریخی تولد من است؟/',
            '/روز تولد من کی می‌شود؟/',
            '/تولد من در چه روزی اتفاق افتاده است؟/',
            '/تاریخ تولد من کی می‌شود؟/',
            '/آیا می‌دانی روز تولد من چه زمانی است؟/',
            '/روز تولدم کی است؟/',
            '/می‌توانی به من بگویی کی به دنیا آمده‌ام؟/',
            '/چند سال پیش متولد شدم؟/',
            '/من کی به دنیا آمده‌ام؟/',
            '/می‌خواهید بگویید تاریخ تولدم چه روزی است؟/',
            '/چند روز دیگر تولدم است؟/',
            '/تاریخ تولد من کدام روز است؟/',
            '/روز تولدم در چه تاریخی بوده است؟/',
            '/سال تولد من چه زمانی بوده است؟/',
            '/آیا می‌توانی به من بگویی تاریخ تولد من چیست؟/',
            '/تاریخ تولد من چیست؟/',
            '/می‌توانی بگویی که چند سال دارم؟/',
            '/آیا می‌دانی کی متولد شدم؟/',
            '/من چه زمانی به دنیا آمده‌ام؟/',
            '/آیا تاریخ تولد من را می‌دانی؟/',
            '/کی در این دنیا به دنیا آمدم؟/',
            '/روز تولد من چه روزی است؟/',
            '/من در چه روزی به دنیا آمده‌ام؟/',
            '/تاریخ روز تولد من کی است؟/',
            '/تولد من در چه سالی بوده است؟/',
            '/چند روز دیگر تا تولدم باقی مانده است؟/',
            '/سال تولدم چه سالی بوده است؟/',
            '/آیا می‌دانی روز تولدم کی می‌شود؟/',
            '/چندم ماه تولدم است؟/',
            '/من در چه ماهی متولد شده‌ام؟/',
            '/آیا می‌توانی بگویی چند سال دارم؟/',
            '/کی به دنیا آمدم؟/',
            '/می‌توانی بگویی تاریخ تولد من چیست؟/',
            '/تاریخ تولدم چه روزی است؟/',
            '/تاریخ تولد من چه روزی بود؟/',
            '/روز تولد من کجاست؟/',
            '/آیا می‌توانی بگویی کی تولد من است؟/',
            '/سال تولد من چه تاریخی است؟/',
            '/روز تولدم چند شنبه بوده است؟/',
            '/چند سالگی من هستم؟/',
            '/من چه تاریخی به دنیا آمده‌ام؟/',
            '/تاریخ دقیق تولد من چیست؟/',
            '/آیا می‌دانی روز تولد من چه زمانی بوده است؟/',
            '/تاریخ سالروز تولدم چه روزی است؟/',
            '/آیا می‌دانید کی تولد من است؟/',
            '/می‌توانی بگویی من چند سال دارم؟/',
            '/تولد من چند روز دیگر است؟/',
            '/من در کدام سال به دنیا آمده‌ام؟/',
            '/چند ساله هستم؟/',
            '/کی سالگرد تولدم است؟/',
            '/می‌دانی که من کی به دنیا آمدم؟/',
            '/تاریخ دقیق تولد من را می‌دانی؟/',
            '/می‌توانی بگویی چه تاریخی تولد من است؟/',
            '/روز تولد من در کدام تاریخ بوده است؟/',
            '/تاریخ تولد من را بگو؟/',
            '/چند سال دیگر تولد من است؟/',
            '/روز تولد من چیست؟/',
            '/تاریخ سالگرد تولد من کی است؟/',
            '/می‌دانی روز تولدم چه تاریخی بوده است؟/',
            '/تاریخ تولد من در چه سالی بوده است؟/',
            '/چند سال به تولدم مانده است؟/',
            '/آیا می‌دانی چند ساله هستم؟/',
            '/آیا می‌توانی بگویی من کی به دنیا آمدم؟/',
            '/تاریخ روز تولد من چیست؟/',
            '/تاریخ تولد من کی بوده است؟/',
            '/روز تولد من در چه ماهی بوده است؟/',
            '/چند ساله به دنیا آمده‌ام؟/',
            '/روز تولد من کدام روز است؟/',
            '/می‌توانی بگویی چند روز به تولد من باقی مانده است؟/',
            '/تاریخ تولد من چیست و چه زمانی است؟/',
            '/می‌توانی بگویی تاریخ تولد من چه زمانی بوده است؟/',
            '/روز تولد من چندم ماه است؟/',
            '/سال تولد من در کدام سال بوده است؟/',
            '/تاریخ دقیق تولد من را بگو؟/',
            '/آیا می‌دانی چند ساله هستم؟/',
            '/من در چه تاریخی به دنیا آمدم؟/',
            '/آیا می‌توانی بگویی چند ساله هستم؟/',
            '/من چه زمانی به دنیا آمده‌ام؟/',
            '/چند سال پیش تولد من بود؟/',
            '/می‌دانی کی روز تولدم است؟/',
            '/روز تولد من چه تاریخی بوده است؟/',
            '/تاریخ تولد من کی به پایان می‌رسد؟/',
            '/چند سالگی من هستم؟/',
        ],
        'name' => [
            '/(?:نام|اسم|هویت) من (?:چیست|چی می‌باشد|چیست؟|چه است|چی دارید|چیست که|چی می‌باشد؟)/',
            '/نام من چیست؟/',
            '/اسم من چیست؟/',
            '/هویت من چه می‌باشد؟/',
            '/می‌توانی بگویی نام من چیست؟/',
            '/آیا نام من را می‌دانی؟/',
            '/نام من چه چیزی است؟/',
            '/اسم من چیه؟/',
            '/اسم من کی است؟/',
            '/آیا می‌خواهید بگویید نام من چیست؟/',
        ],
        'age' => [
            '/(?:سن|چند سال) من چقدر است؟/',
            '/سن من چند سال است؟/',
            '/سن من چقدر می‌شود؟/',
            '/می‌توانی بگویی چند ساله هستم؟/',
            '/چند سال دارم؟/',
            '/سن من چیست؟/',
            '/سن من چیه؟/',
            '/سن من کی به پایان می‌رسد؟/',
            '/سن من کی به چهل می‌رسد؟/',
            '/سن من در حال حاضر چقدر است؟/',
        ],
    ];

    private array $suggestions = [
        'birthday' => [
            'شاید منظورتان روز تولدتان باشد؟',
            'آیا در مورد روز تولدتان سوال داشتید؟',
            'می‌خواهید اطلاعات بیشتری درباره روز تولدتان بدهم؟'
        ],
        'name' => [
            'آیا منظورتان اسم‌تان است؟',
            'شاید منظورتان اسم شما باشد؟',
            'آیا درباره نام خود می‌پرسید؟'
        ],
        'age' => [
            'آیا منظورتان سن‌تان است؟',
            'می‌خواهید سن‌تان را بدانید؟',
            'شاید در مورد سن‌تان سوال داشتید؟'
        ]
    ];

    public function processQuery(string $query) : ? string {

        $patterns = require ('App/patterns.php');

        foreach ($patterns as $action => $pattern) {

            foreach ($pattern as $item) {

                if (preg_match($item, $query)) {

                    return $action;

                }

            }

        }

        return $this->suggestSimilarQuery($query);
    }

    public function suggestSimilarQuery(string $query) : string {

        $patterns    = require ('App/patterns.php');
        $suggestions = require ('App/suggestions.php');

        $bestMatch = null;
        $minDistance = PHP_INT_MAX;

        foreach ($patterns as $action => $pattern) {
            foreach ($pattern as $item) {

                $distance = levenshtein($query, $item);

                if ($distance < $minDistance && $distance <= 60) {
                    $minDistance = $distance;
                    $bestMatch = $action;
                }
            }
        }

        if ($bestMatch !== null) {
            return $suggestions[$bestMatch][array_rand($suggestions[$bestMatch])];
        }

        return "متوجه نشدم. لطفاً سوال خود را به گونه‌ای دیگر بپرسید.";
    }
}