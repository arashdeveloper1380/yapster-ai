<?php

namespace YapsterAi;

class NLPProcessor {

    private array $patterns = [
        'birthday' => [
            '/(?:تولد|روز تولد|زمان تولد|تاریخ تولد) من (?:کی است|کی می‌باشد|چیست|بیشتر بگو|می‌باشد|چیست؟|کی|چه زمانی|چه روزی)/',
            '/آیا می‌توانی بگویی روز تولد من چیست؟/',
            '/تاریخ تولد من کی است؟/',
            '/تاریخ تولد من چند است؟/',
            '/چندم تولد من است؟/',
            '/می‌خواهید بگویید تولد من چه زمانی است؟/',
            '/تولد من چه روزی است؟/',
            '/چه تاریخی تولد من است؟/',
            '/روز تولد من کی می‌شود؟/',
            '/تولد من در چه روزی اتفاق افتاده است?/',
        ],
        'name' => [
            '/(?:نام|اسم|هویت) من (?:چیست|چی می‌باشد|چیست؟|چه است|چی دارید|چیست که|چی می‌باشد؟)/',
            '/نام من چیست؟/',
            '/اسم من چیست؟/',
            '/هویت من چه می‌باشد؟/',
            '/می‌توانی بگویی نام من چیست؟/',
            '/آیا نام من را می‌دانی؟/',
            '/نام من چه چیزی است؟/',
            '/اسم من چیه؟/',
            '/اسم من کی است؟/',
            '/آیا می‌خواهید بگویید نام من چیست؟/',
        ],
        'age' => [
            '/(?:سن|چند سال) من چقدر است؟/',
            '/سن من چند سال است؟/',
            '/سن من چقدر می‌شود؟/',
            '/می‌توانی بگویی چند ساله هستم؟/',
            '/چند سال دارم؟/',
            '/سن من چیست؟/',
            '/سن من چیه؟/',
            '/سن من کی به پایان می‌رسد؟/',
            '/سن من کی به چهل می‌رسد؟/',
            '/سن من در حال حاضر چقدر است؟/',
        ],
    ];

    private array $suggestions = [
        'birthday' => [
            'شاید منظورتان روز تولدتان باشد؟',
            'آیا در مورد روز تولدتان سوال داشتید؟',
            'می‌خواهید اطلاعات بیشتری درباره روز تولدتان بدهم؟'
        ],
        'name' => [
            'آیا منظورتان اسم‌تان است؟',
            'شاید منظورتان اسم شما باشد؟',
            'آیا درباره نام خود می‌پرسید؟'
        ],
        'age' => [
            'آیا منظورتان سن‌تان است؟',
            'می‌خواهید سن‌تان را بدانید؟',
            'شاید در مورد سن‌تان سوال داشتید؟'
        ]
    ];

    public function proccessQuery(string $query) : ? string{
        foreach ($this->patterns as $action => $patterns) {
            foreach ($patterns as $pattern) {
                if (preg_match($pattern, $query)) {
                    return $action;
                }
            }
        }
        return $this->suggestSimilarQuery($query);
    }

    public function suggestSimilarQuery(string $query): string {
        $bestMatch = null;
        $minDistance = PHP_INT_MAX;

        foreach ($this->patterns as $action => $patterns) {
            foreach ($patterns as $pattern) { // حلقه جدید برای الگوهای هر عمل
                // دریافت فاصله بین query و الگو
                $distance = levenshtein($query, $pattern);

                // بررسی اینکه آیا فاصله در یک محدوده معقول است
                if ($distance < $minDistance && $distance <= 60) { // می‌توانید این آستانه را تنظیم کنید
                    $minDistance = $distance;
                    $bestMatch = $action;
                }
            }
        }

        if ($bestMatch !== null) {
            // انتخاب تصادفی از جملات پیشنهادی برای intent پیدا شده
            $randomSuggestion = $this->suggestions[$bestMatch][array_rand($this->suggestions[$bestMatch])];
            return $randomSuggestion;
        }

        // در صورتی که هیچ شباهتی پیدا نشود
        return "متوجه نشدم. لطفاً سوال خود را به گونه‌ای دیگر بپرسید.";
    }
}